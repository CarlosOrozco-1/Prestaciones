<!-- Stepper Header -->
<div class="stepper-container">
  <div class="stepper-header">
    <div class="step" 
         [class.active]="currentStep >= 1" 
         [class.completed]="currentStep > 1"
         (click)="goToStep(1)">
      <div class="step-number">1</div>
      <div class="step-title">Tipo de C√°lculo</div>
    </div>
    
    <div class="step-connector" [class.active]="currentStep > 1"></div>
    
    <div class="step" 
         [class.active]="currentStep >= 2" 
         [class.completed]="currentStep > 2"
         (click)="goToStep(2)">
      <div class="step-number">2</div>
      <div class="step-title">Datos Personales</div>
    </div>
    
    <div class="step-connector" [class.active]="currentStep > 2"></div>
    
    <div class="step" 
         [class.active]="currentStep >= 3" 
         [class.completed]="currentStep > 3"
         (click)="goToStep(3)">
      <div class="step-number">3</div>
      <div class="step-title">Datos Laborales</div>
    </div>
    
    <div class="step-connector" [class.active]="currentStep > 3"></div>
    
    <div class="step" 
         [class.active]="currentStep >= 4" 
         [class.completed]="currentStep > 4">
      <div class="step-number">4</div>
      <div class="step-title">Resultado</div>
    </div>
  </div>
</div>

<!-- Main Content Steper-->
<div class="calculator-container">
  
  <!-- Paso 1: Selecci√≥n del Tipo de Prestaci√≥n -->
  <div class="step-content" *ngIf="currentStep === 1">
    <div class="step-header">
      <h2>Selecciona el tipo de prestaci√≥n a calcular</h2>
      <p>Elige el concepto que deseas calcular de forma manual</p>
    </div>
    
    <form [formGroup]="tipoSeleccionForm" class="prestaciones-grid">
      <div class="prestacion-card" 
           *ngFor="let tipo of tiposPrestaciones"
           [class.selected]="tipoSeleccionado?.id === tipo.id"
           (click)="seleccionarTipo(tipo)">
        
        <div class="prestacion-icon">{{tipo.icon}}</div>
        <h3>{{tipo.nombre}}</h3>
        <p>{{tipo.descripcion}}</p>
        
        <div class="formula-preview">
          <strong>F√≥rmula:</strong>
          <code>{{tipo.formula}}</code>
        </div>
      </div>
    </form>
    
    <div class="selected-info" *ngIf="tipoSeleccionado">
      <div class="info-card">
        <h4>{{tipoSeleccionado.icon}} {{tipoSeleccionado.nombre}} seleccionado</h4>
        <p>{{tipoSeleccionado.descripcion}}</p>
      </div>
    </div>
  </div>

  <!-- Paso 2: Datos Personales -->
  <div class="step-content" *ngIf="currentStep === 2">
    <div class="step-header">
      <h2>Datos del Trabajador</h2>
      <p>Ingresa la informaci√≥n personal del trabajador</p>
    </div>
    
    <form [formGroup]="datosPersonalesForm" class="form-grid">
      <div class="form-group">
        <label for="nombreCompleto">Nombre Completo *</label>
        <input 
          type="text" 
          id="nombreCompleto"
          formControlName="nombreCompleto"
          class="form-control"
          placeholder="Ingrese el nombre completo">
        <div class="error-message" 
             *ngIf="datosPersonalesForm.get('nombreCompleto')?.errors?.['required'] && 
                    datosPersonalesForm.get('nombreCompleto')?.touched">
          El nombre completo es requerido
        </div>
      </div>

      <div class="form-group">
        <label for="identificacion">N√∫mero de Identificaci√≥n</label>
        <input 
          type="text" 
          id="identificacion"
          formControlName="identificacion"
          class="form-control"
          placeholder="C√©dula, NIT, etc. (Opcional)">
      </div>

      <div class="form-group full-width">
        <label for="cargo">Cargo *</label>
        <input 
          type="text" 
          id="cargo"
          formControlName="cargo"
          class="form-control"
          placeholder="Cargo o posici√≥n en la empresa">
        <div class="error-message" 
             *ngIf="datosPersonalesForm.get('cargo')?.errors?.['required'] && 
                    datosPersonalesForm.get('cargo')?.touched">
          El cargo es requerido
        </div>
      </div>
    </form>
  </div>

  <!-- Paso 3: Datos Laborales -->
  <div class="step-content" *ngIf="currentStep === 3">
    <div class="step-header">
      <h2>Informaci√≥n Laboral y Salarial</h2>
      <p>Ingresa los datos necesarios para el c√°lculo de {{tipoSeleccionado?.nombre}}</p>
    </div>
    
    <form [formGroup]="datosLaboralesForm" class="form-grid">
      <div class="form-group">
        <label for="salarioBase">Salario Base Mensual *</label>
        <input 
          type="number" 
          id="salarioBase"
          formControlName="salarioBase"
          class="form-control"
          placeholder="0"
          min="0">
        <div class="error-message" 
             *ngIf="datosLaboralesForm.get('salarioBase')?.errors && 
                    datosLaboralesForm.get('salarioBase')?.touched">
          <span *ngIf="datosLaboralesForm.get('salarioBase')?.errors?.['required']">
            El salario base es requerido
          </span>
          <span *ngIf="datosLaboralesForm.get('salarioBase')?.errors?.['min']">
            El salario debe ser mayor a 0
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="auxilioTransporte">Auxilio de Transporte</label>
        <input 
          type="number" 
          id="auxilioTransporte"
          formControlName="auxilioTransporte"
          class="form-control"
          placeholder="0"
          min="0">
      </div>

      <div class="form-group">
        <label for="fechaInicio">Fecha de Inicio *</label>
        <input 
          type="date" 
          id="fechaInicio"
          formControlName="fechaInicio"
          class="form-control">
        <div class="error-message" 
             *ngIf="datosLaboralesForm.get('fechaInicio')?.errors?.['required'] && 
                    datosLaboralesForm.get('fechaInicio')?.touched">
          La fecha de inicio es requerida
        </div>
      </div>

      <div class="form-group">
        <label for="fechaFin">Fecha de Fin *</label>
        <input 
          type="date" 
          id="fechaFin"
          formControlName="fechaFin"
          class="form-control">
        <div class="error-message" 
             *ngIf="datosLaboralesForm.get('fechaFin')?.errors?.['required'] && 
                    datosLaboralesForm.get('fechaFin')?.touched">
          La fecha de fin es requerida
        </div>
      </div>

      <div class="form-group">
        <label for="diasTrabajados">D√≠as Trabajados</label>
        <input 
          type="number" 
          id="diasTrabajados"
          formControlName="diasTrabajados"
          class="form-control"
          readonly>
        <small class="form-help">Se calcula autom√°ticamente basado en las fechas</small>
      </div>

      <div class="form-group">
        <label for="horasExtras">Horas Extras (Valor mensual)</label>
        <input 
          type="number" 
          id="horasExtras"
          formControlName="horasExtras"
          class="form-control"
          placeholder="0"
          min="0">
      </div>

      <div class="form-group">
        <label for="bonificaciones">Bonificaciones</label>
        <input 
          type="number" 
          id="bonificaciones"
          formControlName="bonificaciones"
          class="form-control"
          placeholder="0"
          min="0">
      </div>
    </form>

    <!-- Resumen de datos laborales -->
    <div class="datos-resumen" *ngIf="datosLaboralesForm.get('salarioBase')?.value > 0">
      <h4>Resumen Salarial</h4>
      <div class="resumen-grid">
        <div class="resumen-item">
          <span>Salario Base:</span>
          <span>{{formatCurrency(datosLaboralesForm.get('salarioBase')?.value || 0)}}</span>
        </div>
        <div class="resumen-item">
          <span>Per√≠odo:</span>
          <span>{{formatDate(datosLaboralesForm.get('fechaInicio')?.value)}} - {{formatDate(datosLaboralesForm.get('fechaFin')?.value)}}</span>
        </div>
        <div class="resumen-item">
          <span>D√≠as trabajados:</span>
          <span>{{datosLaboralesForm.get('diasTrabajados')?.value || 0}} d√≠as</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Paso 4: Resultado del C√°lculo -->
  <div class="step-content" *ngIf="currentStep === 4">
    <div class="step-header">
      <h2>Resultado del C√°lculo</h2>
      <p>C√°lculo de {{tipoSeleccionado?.nombre}}</p>
    </div>

    <!-- Loading Estado -->
    <div class="loading-container" *ngIf="isCalculating">
      <div class="loading-spinner"></div>
      <p>Realizando c√°lculo...</p>
    </div>

    <!-- Resultado -->
    <div class="resultado-container" *ngIf="resultado && !isCalculating">
      
      <!-- Informaci√≥n del empleado -->
      <div class="empleado-info">
        <h3>üë§ Informaci√≥n del Trabajador</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Nombre:</span>
            <span class="value">{{resultado.detalles['nombreEmpleado']}}</span>
          </div>
          <div class="info-item">
            <span class="label">Cargo:</span>
            <span class="value">{{resultado.detalles['cargo']}}</span>
          </div>
          <div class="info-item" *ngIf="resultado.detalles['identificacion']">
            <span class="label">Identificaci√≥n:</span>
            <span class="value">{{resultado.detalles['identificacion']}}</span>
          </div>
        </div>
      </div>

      <!-- Resultado principal -->
      <div class="resultado-principal">
        <h3>{{tipoSeleccionado?.icon}} {{resultado.concepto}}</h3>
        <div class="valor-principal">
          {{formatCurrency(resultado.valor)}}
        </div>
      </div>

      <!-- NUEVO: Secci√≥n especial para vacaciones - Dos rubros -->
      <div class="vacaciones-rubros" *ngIf="tipoSeleccionado?.id === 'vacaciones'">
        <h4>üìã Rubros de Vacaciones seg√∫n C√≥digo de Trabajo Guatemala</h4>
        <div class="rubros-container">
          <div class="rubro-card">
            <div class="rubro-header">
              <span class="rubro-icon">üèñÔ∏è</span>
              <h5>1. D√≠as de Vacaciones</h5>
            </div>
            <div class="rubro-content">
              <div class="rubro-valor">{{resultado.detalles['diasVacacionesProporcionales']}} d√≠as</div>
              <p class="rubro-descripcion">
                D√≠as de descanso que corresponden al trabajador seg√∫n el tiempo laborado.
                Base legal: Art√≠culo 130 C√≥digo de Trabajo de Guatemala.
              </p>
            </div>
          </div>
          
          <div class="rubro-card">
            <div class="rubro-header">
              <span class="rubro-icon">üí∞</span>
              <h5>2. Compensaci√≥n por Vacaciones No Gozadas</h5>
            </div>
            <div class="rubro-content">
              <div class="rubro-valor">{{formatCurrency(resultado.detalles['compensacionTotal'])}}</div>
              <p class="rubro-descripcion">
                Pago que debe recibir el trabajador si es despedido sin haber gozado sus vacaciones.
                <strong>F√≥rmula:</strong> (Salario mensual √∑ 30 d√≠as) √ó D√≠as de vacaciones no gozados.
                Incluye compensaci√≥n adicional del 50% por no goce efectivo.
              </p>
              <div class="rubro-desglose">
                <div class="desglose-item">
                  <span>Compensaci√≥n b√°sica:</span>
                  <span>{{formatCurrency(resultado.detalles['compensacionBasica'])}}</span>
                </div>
                <div class="desglose-item">
                  <span>Compensaci√≥n por no goce (+50%):</span>
                  <span>{{formatCurrency(resultado.detalles['compensacionAdicional'])}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- FIN: Secci√≥n especial para vacaciones -->

      <!-- F√≥rmula utilizada -->
      <div class="formula-container">
        <h4>üìê F√≥rmula Utilizada</h4>
        <div class="formula-card">
          <div class="formula-math">{{resultado.formula}}</div>
          <div class="formula-calculo">{{resultado.detalles['calculoDetallado']}}</div>
        </div>
      </div>

      <!-- Detalles del c√°lculo -->
      <div class="detalles-calculo">
        <h4>üîç Detalles del C√°lculo</h4>
        <div class="detalles-grid">
          <div class="detalle-item" *ngIf="resultado.detalles['salarioBase']">
            <span class="label">Salario Base:</span>
            <span class="value">{{formatCurrency(resultado.detalles['salarioBase'])}}</span>
          </div>
          <!-- NUEVO: Mostrar salario diario calculado -->
          <div class="detalle-item" *ngIf="resultado.detalles['salarioDiario']">
            <span class="label">Salario Diario (√∑30):</span>
            <span class="value">{{formatCurrency(resultado.detalles['salarioDiario'])}}</span>
          </div>
          <div class="detalle-item" *ngIf="resultado.detalles['diasTrabajados']">
            <span class="label">D√≠as trabajados:</span>
            <span class="value">{{resultado.detalles['diasTrabajados']}} d√≠as</span>
          </div>
          
          <!-- NUEVO: Campos espec√≠ficos para vacaciones mejoradas -->
          <div class="detalle-item" *ngIf="resultado.detalles['diasVacacionesAnuales']">
            <span class="label">D√≠as vacaciones anuales:</span>
            <span class="value">{{resultado.detalles['diasVacacionesAnuales']}} d√≠as</span>
          </div>
          <div class="detalle-item" *ngIf="resultado.detalles['diasVacacionesProporcionales']">
            <span class="label">D√≠as vacaciones proporcionales:</span>
            <span class="value">{{resultado.detalles['diasVacacionesProporcionales']}} d√≠as</span>
          </div>
          <div class="detalle-item" *ngIf="resultado.detalles['compensacionBasica']">
            <span class="label">Compensaci√≥n b√°sica:</span>
            <span class="value">{{formatCurrency(resultado.detalles['compensacionBasica'])}}</span>
          </div>
          <div class="detalle-item" *ngIf="resultado.detalles['compensacionAdicional']">
            <span class="label">Compensaci√≥n por no goce (+50%):</span>
            <span class="value">{{formatCurrency(resultado.detalles['compensacionAdicional'])}}</span>
          </div>
          <!-- FIN: Campos espec√≠ficos para vacaciones -->
          
          <div class="detalle-item" *ngIf="resultado.detalles['diasVacaciones']">
            <span class="label">D√≠as de vacaciones:</span>
            <span class="value">{{resultado.detalles['diasVacaciones']}} d√≠as</span>
          </div>
          <div class="detalle-item" *ngIf="resultado.detalles['anosServicio']">
            <span class="label">A√±os de servicio:</span>
            <span class="value">{{resultado.detalles['anosServicio'].toFixed(2)}} a√±os</span>
          </div>
        </div>
      </div>

      <!-- Nota legal -->
      <div class="nota-legal">
        <p><strong>‚ö†Ô∏è Nota importante:</strong> Este c√°lculo es referencial y se basa en la normativa laboral guatemalteca general. Para c√°lculos oficiales, consulte con un profesional en derecho laboral o recursos humanos, o consulte el C√≥digo de Trabajo de Guatemala.</p>
      </div>
    </div>
  </div>
  
  <!-- Navegaci√≥n del Stepper -->
  <div class="stepper-navigation">
    <button 
      type="button" 
      class="btn btn-secondary"
      [disabled]="currentStep <= 1"
      (click)="prevStep()">
      ‚Üê Anterior
    </button>

    <div class="step-indicator">
      Paso {{currentStep}} de {{maxSteps}}
    </div>

    <button 
      type="button" 
      class="btn btn-primary"
      *ngIf="currentStep < maxSteps"
      [disabled]="!isStepValid(currentStep)"
      (click)="nextStep()">
      Siguiente ‚Üí
    </button>

    <button 
      type="button" 
      class="btn btn-success"
      *ngIf="currentStep === maxSteps && resultado"
      (click)="nuevoCalculo()">
      Nuevo C√°lculo
    </button>
  </div>
</div>